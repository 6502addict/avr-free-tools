# DS1302 RTC Library for AVR

A lightweight C library for interfacing with the DS1302 Real-Time Clock chip on AVR microcontrollers.

## Features

- Simple 3-wire serial interface (CE, SCLK, I/O)
- Read/write date and time
- BCD conversion handled automatically
- Clock halt control
- Write protection support
- Multi-MCU support with automatic pin configuration
- No external dependencies

## Supported Microcontrollers

- ATmega328P (Arduino Uno)
- ATmega1284P
- ATmega2560 (Arduino Mega 2560)
- ATtiny2313/ATtiny2313A

## Hardware Connections

### Arduino Uno (ATmega328P)
| DS1302 Pin | Arduino Pin | AVR Pin |
|------------|-------------|---------|
| CE (RST)   | D5          | PD5     |
| SCLK (CLK) | D6          | PD6     |
| I/O (DAT)  | D7          | PD7     |
| VCC        | 5V          | -       |
| GND        | GND         | -       |

### Arduino Mega 2560 (ATmega2560)
| DS1302 Pin | Arduino Pin | AVR Pin |
|------------|-------------|---------|
| CE (RST)   | D41         | PG0     |
| SCLK (CLK) | D40         | PG1     |
| I/O (DAT)  | D39         | PG2     |
| VCC        | 5V          | -       |
| GND        | GND         | -       |

### ATmega1284P
| DS1302 Pin | AVR Pin |
|------------|---------|
| CE (RST)   | PB0     |
| SCLK (CLK) | PB1     |
| I/O (DAT)  | PB2     |
| VCC        | 5V      |
| GND        | GND     |

### ATtiny2313
| DS1302 Pin | AVR Pin |
|------------|---------|
| CE (RST)   | PD3     |
| SCLK (CLK) | PD4     |
| I/O (DAT)  | PD5     |
| VCC        | 5V      |
| GND        | GND     |

**Note:** The DS1302 also requires a 32.768 kHz crystal between X1 and X2 pins, and a backup battery (3V coin cell) on VBAT for timekeeping when main power is off.

## Building the Library

### Build for specific MCU
```bash
make MCU=atmega328p F_CPU=16000000UL
```

### Build for all supported MCUs
```bash
make all-mcus
```

### Install library
```bash
# Install for current MCU
make install

# Install all MCU variants
make install-all
```

## API Reference

### Data Structures

#### `ds1302_time_t`
```c
typedef struct {
    uint8_t seconds;    // 0-59
    uint8_t minutes;    // 0-59
    uint8_t hours;      // 0-23 (24-hour format)
    uint8_t date;       // 1-31
    uint8_t month;      // 1-12
    uint8_t day;        // 1-7 (day of week: 1=Sunday, 7=Saturday)
    uint8_t year;       // 0-99 (2000-2099)
} ds1302_time_t;
```

### Functions

#### `void ds1302_init(void)`
Initialize the DS1302 RTC.
- Configures GPIO pins
- Disables write protection
- Must be called before any other DS1302 functions

**Example:**
```c
ds1302_init();
```

#### `void ds1302_set_time(ds1302_time_t *time)`
Set the current date and time.

**Parameters:**
- `time`: Pointer to `ds1302_time_t` structure with desired time

**Example:**
```c
ds1302_time_t time;
time.hours = 14;
time.minutes = 30;
time.seconds = 0;
time.date = 31;
time.month = 10;
time.year = 25;      // 2025
time.day = 5;        // Friday
ds1302_set_time(&time);
```

#### `void ds1302_get_time(ds1302_time_t *time)`
Read the current date and time.

**Parameters:**
- `time`: Pointer to `ds1302_time_t` structure to store the time

**Example:**
```c
ds1302_time_t time;
ds1302_get_time(&time);
```

#### `void ds1302_halt(uint8_t enable)`
Halt or resume the clock.

**Parameters:**
- `enable`: 1 to halt the clock, 0 to resume

**Example:**
```c
ds1302_halt(1);  // Stop the clock
ds1302_halt(0);  // Start the clock
```

#### `void ds1302_write_byte(uint8_t addr, uint8_t data)`
Low-level function to write a byte to DS1302 register.

**Parameters:**
- `addr`: Register address
- `data`: Data byte to write

#### `uint8_t ds1302_read_byte(uint8_t addr)`
Low-level function to read a byte from DS1302 register.

**Parameters:**
- `addr`: Register address

**Returns:** Data byte read from register

## Usage Examples

### Basic Example - Set and Read Time
```c
#include <avr/io.h>
#include <util/delay.h>
#include "ds1302.h"

int main(void) {
    ds1302_time_t time;
    
    // Initialize DS1302
    ds1302_init();
    
    // Set initial time: 14:30:00, Friday, October 31, 2025
    time.hours = 14;
    time.minutes = 30;
    time.seconds = 0;
    time.date = 31;
    time.month = 10;
    time.year = 25;      // 2025
    time.day = 5;        // 1=Sun, 2=Mon, ..., 5=Fri
    
    ds1302_set_time(&time);
    
    // Main loop - read time every second
    while(1) {
        ds1302_get_time(&time);
        
        // Use time data here
        // e.g., display on LCD, send via UART, etc.
        
        _delay_ms(1000);
    }
    
    return 0;
}
```

### Example with UART Output
```c
#include <avr/io.h>
#include <util/delay.h>
#include <stdio.h>
#include "ds1302.h"
#include "uart.h"  // Your UART library

int main(void) {
    ds1302_time_t time;
    char buffer[32];
    
    uart_init();
    ds1302_init();
    
    while(1) {
        ds1302_get_time(&time);
        
        // Format time as string
        sprintf(buffer, "%02d/%02d/20%02d %02d:%02d:%02d\r\n",
                time.date, time.month, time.year,
                time.hours, time.minutes, time.seconds);
        
        uart_puts(buffer);
        
        _delay_ms(1000);
    }
    
    return 0;
}
```

### Example - First-Time Setup Check
```c
#include <avr/io.h>
#include "ds1302.h"

int main(void) {
    ds1302_time_t time;
    
    ds1302_init();
    
    // Read current time
    ds1302_get_time(&time);
    
    // Check if time is valid (simple check)
    if (time.year == 0 || time.month == 0 || time.month > 12) {
        // DS1302 needs initialization - set default time
        time.hours = 0;
        time.minutes = 0;
        time.seconds = 0;
        time.date = 1;
        time.month = 1;
        time.year = 25;      // 2025
        time.day = 1;        // Sunday
        
        ds1302_set_time(&time);
    }
    
    while(1) {
        // Your application code
    }
    
    return 0;
}
```

## Compiling Your Application

### Using the installed library
```bash
avr-gcc -mmcu=atmega328p -DF_CPU=16000000UL -Os -Wall \
    -I$HOME/avr/template/include \
    -o main.elf main.c \
    -L$HOME/avr/template/lib -lds1302_atmega328p

avr-objcopy -O ihex -R .eeprom main.elf main.hex
```

### Makefile example
```makefile
MCU = atmega328p
F_CPU = 16000000UL
TARGET = main

CC = avr-gcc
OBJCOPY = avr-objcopy

CFLAGS = -mmcu=$(MCU) -DF_CPU=$(F_CPU) -Os -Wall
CFLAGS += -I$(HOME)/avr/template/include

LDFLAGS = -L$(HOME)/avr/template/lib -lds1302_$(MCU)

all: $(TARGET).hex

$(TARGET).elf: $(TARGET).c
	$(CC) $(CFLAGS) -o $@ $< $(LDFLAGS)

$(TARGET).hex: $(TARGET).elf
	$(OBJCOPY) -O ihex -R .eeprom $< $@

flash: $(TARGET).hex
	avrdude -c arduino -p $(MCU) -P /dev/ttyUSB0 -U flash:w:$

clean:
	rm -f *.elf *.hex *.o
```

## Day of Week Encoding

The `day` field uses the following encoding:
- 1 = Sunday
- 2 = Monday
- 3 = Tuesday
- 4 = Wednesday
- 5 = Thursday
- 6 = Friday
- 7 = Saturday

## Important Notes

1. **Backup Battery**: The DS1302 requires a backup battery (typically CR2032) connected to VBAT to maintain time when main power is off.

2. **Crystal**: A 32.768 kHz crystal must be connected between X1 and X2 pins for accurate timekeeping.

3. **First Use**: On first use or after battery replacement, the DS1302 needs to be initialized with the current date and time.

4. **Write Protection**: The library automatically manages write protection. It's disabled during writes and re-enabled afterward.

5. **BCD Conversion**: All time values are in decimal format. The library handles BCD conversion internally.

6. **24-Hour Format**: The library uses 24-hour time format (0-23 hours).

## Troubleshooting

### Clock not running
- Check if clock is halted: `ds1302_halt(0);`
- Verify 32.768 kHz crystal connections
- Check backup battery voltage (should be ~3V)

### Wrong time after power cycle
- Verify backup battery is installed and has sufficient voltage
- Check battery holder connections

### Time not updating
- Ensure `ds1302_init()` is called before other functions
- Verify wire connections (CE, SCLK, I/O)
- Check for correct pin definitions for your MCU

### Compilation errors
- Ensure the library is installed: `make install`
- Check include path points to library location
- Verify correct MCU is specified in your Makefile

## Register Map (Advanced)

For direct register access using `ds1302_read_byte()` and `ds1302_write_byte()`:

| Register    | Address | Description           |
|-------------|---------|------------------------|
| DS1302_SEC  | 0x80    | Seconds (+ CH bit)    |
| DS1302_MIN  | 0x82    | Minutes               |
| DS1302_HOUR | 0x84    | Hours                 |
| DS1302_DATE | 0x86    | Date of month         |
| DS1302_MONTH| 0x88    | Month                 |
| DS1302_DAY  | 0x8A    | Day of week           |
| DS1302_YEAR | 0x8C    | Year                  |
| DS1302_WP   | 0x8E    | Write protect         |

## License

This library is provided as-is for educational and commercial use.

## Version

Version 1.0 - Initial release