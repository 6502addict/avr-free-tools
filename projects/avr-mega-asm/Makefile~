# Multi-AVR Serial Echo Makefile (AVRA Assembler)
# Supports: ATmega328P, ATmega2560, ATmega1284P

# Target chip selection
MCU ?= atmega328p

#Programmer types:
# AVR ISP MKII   avrispmkii
# Atmel ICE      atmelice_isp / atmelice_pdi / atmelice_pdi
# Atmel STK 500  stk500v2 

PROGRAMMER = avrispmkii

# Chip-specific settings
ifeq ($(MCU),atmega328p)
    F_CPU = 16000000
    BAUD = 38400
    ASMFLAGS = -D ATmega328P
endif

ifeq ($(MCU),atmega2560)
    F_CPU = 16000000
    BAUD = 38400
    ASMFLAGS = -D ATmega2560
endif

ifeq ($(MCU),atmega1284p)
    F_CPU = 8000000
    BAUD = 38400
    ASMFLAGS = -D ATmega1284P
endif

# Project name
TARGET = serial_echo

# Source file
SRC = $(TARGET).asm

# Tools
ASM = avra
AVRDUDE = avrdude

# Assembler flags
ASMFLAGS += -fI
ASMFLAGS += -I /usr/local/include/avr
ASMFLAGS += -D F_CPU=$(F_CPU)
ASMFLAGS += -D BAUD=$(BAUD)

# Avrdude flags
AVRDUDE_FLAGS = -p $(MCU) -c $(PROGRAMMER)
AVRDUDE_FLAGS += -P /dev/ttyUSB0

# Default target
all: $(TARGET).hex

# Assemble
$(TARGET).hex: $(SRC)
	@echo "Assembling for $(MCU)..."
	$(ASM) $(ASMFLAGS)  $(SRC)
	@if [ -f $(TARGET).eep.hex ]; then \
		echo "EEPROM file created: $(TARGET).eep.hex"; \
	fi

# Upload to chip
upload: $(TARGET).hex
	@echo "Uploading to $(MCU)..."
	$(AVRDUDE) $(AVRDUDE_FLAGS) -U flash:w:$(TARGET).hex:i

# Clean
clean:
	@echo "Cleaning..."
	rm -f $(TARGET).hex $(TARGET).eep.hex $(TARGET).obj $(TARGET).cof

# Build for all chips
all-chips:
	@echo "Building for all chips..."
	@make clean
	@make MCU=atmega328p
	@mv $(TARGET).hex $(TARGET)_328p.hex
	@make clean
	@make MCU=atmega2560
	@mv $(TARGET).hex $(TARGET)_2560.hex
	@make clean
	@make MCU=atmega1284p
	@mv $(TARGET).hex $(TARGET)_1284p.hex
	@echo "Done! Created: $(TARGET)_328p.hex, $(TARGET)_2560.hex, $(TARGET)_1284p.hex"

# Help
help:
	@echo "Multi-AVR Serial Echo Build System (AVRA)"
	@echo ""
	@echo "Usage:"
	@echo "  make MCU=atmega328p      - Build for ATmega328P (default)"
	@echo "  make MCU=atmega2560      - Build for ATmega2560"
	@echo "  make MCU=atmega1284p     - Build for ATmega1284P"
	@echo "  make upload              - Upload to chip"
	@echo "  make all-chips           - Build for all chips"
	@echo "  make clean               - Remove build files"
	@echo ""
	@echo "Example:"
	@echo "  make MCU=atmega2560 upload"

.PHONY: all clean upload help all-chips
